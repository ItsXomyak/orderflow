# OrderFlow - Система обработки заказов с Temporal.io

## Обзор проекта

OrderFlow - это упрощенная система обработки заказов, построенная на базе Temporal.io для оркестрации рабочих процессов. Система моделирует полный цикл обработки заказа от создания до уведомления клиента.

## Архитектура

Проект построен по многослойной архитектуре:

```
┌─────────────────────────────────────────────────────────────┐
│                    Web Interface (HTML/JS)                  │
├─────────────────────────────────────────────────────────────┤
│                    API Layer (Gin)                         │
├─────────────────────────────────────────────────────────────┤
│                 Temporal Workflows                          │
├─────────────────────────────────────────────────────────────┤
│                 Temporal Activities                         │
├─────────────────────────────────────────────────────────────┤
│                 Domain Services (Mock)                      │
├─────────────────────────────────────────────────────────────┤
│                 PostgreSQL Database                         │
└─────────────────────────────────────────────────────────────┘
```

## Технологический стек

- **Backend**: Go 1.23
- **Workflow Engine**: Temporal.io
- **Web Framework**: Gin
- **Database**: PostgreSQL 15
- **Cache/Queue**: Redis 7
- **Containerization**: Docker & Docker Compose
- **Logging**: Zap Logger
- **Frontend**: HTML, JavaScript, Bootstrap

## Структура проекта

### Корневые файлы

- **`go.mod`** - Go модуль с зависимостями
- **`go.sum`** - Хеши зависимостей
- **`Makefile`** - Команды для сборки, запуска и управления
- **`README.md`** - Основная документация проекта
- **`DOCS.md`** - Этот файл с подробной документацией
- **`docker-compose.yml`** - Конфигурация Docker сервисов
- **`Dockerfile`** - Многоэтапная сборка Docker образов
- **`.dockerignore`** - Файлы для исключения из Docker контекста
- **`.gitignore`** - Файлы для исключения из Git

### Директории

#### `/cmd` - Точки входа приложения

- **`/cmd/api/main.go`** - API сервер (Gin)
- **`/cmd/worker/main.go`** - Temporal Worker

#### `/internal` - Внутренняя логика приложения

- **`/internal/domain`** - Доменные модели и сервисы
  - **`/internal/domain/order/order.go`** - Модели заказов
  - **`/internal/domain/inventory/inventory.go`** - Сервис инвентаря (mock)
  - **`/internal/domain/payment/payment.go`** - Сервис платежей (mock)
  - **`/internal/domain/notification/notification.go`** - Сервис уведомлений (mock)
- **`/internal/application`** - Слой приложения
  - **`/internal/application/workflow/order_workflow.go`** - Temporal Workflows
  - **`/internal/application/workflow/activities.go`** - Temporal Activities

#### `/templates` - HTML шаблоны

- **`/templates/index.html`** - Веб-интерфейс для управления заказами

#### `/static` - Статические файлы

- **`/static/placeholder.txt`** - Заглушка для Docker

#### `/migrations` - Миграции базы данных

- **`/migrations/001_init_schema.sql`** - Инициализация схемы PostgreSQL

#### `/temporal-config` - Конфигурация Temporal

- **`/temporal-config/dynamicconfig/development-sql.yaml`** - Настройки для PostgreSQL

## Что реализовано

### ✅ Реализовано

#### 1. Доменные модели

- **Order**: Структура заказа с ID, статусом, суммой
- **OrderStatus**: Перечисление статусов заказа
- **OrderRequest**: Запрос на создание заказа

#### 2. Temporal Workflows

- **OrderWorkflow**: Основной workflow обработки заказа
- **OrderWorkflowWithCancellation**: Workflow с поддержкой отмены

#### 3. Temporal Activities

- **CreateOrderActivity**: Создание заказа
- **CheckInventoryActivity**: Проверка наличия товара
- **ProcessPaymentActivity**: Обработка платежа
- **SendNotificationActivity**: Отправка уведомления
- **CancelOrderActivity**: Отмена заказа

#### 4. API Endpoints

- **POST /api/orders** - Создание нового заказа
- **GET /api/orders/:id** - Получение статуса заказа
- **POST /api/orders/:id/cancel** - Отмена заказа
- **GET /** - Веб-интерфейс

#### 5. Веб-интерфейс

- Форма создания заказа
- Отображение статуса заказа
- Возможность отмены заказа
- Bootstrap стилизация

#### 6. Docker инфраструктура

- PostgreSQL 15 с инициализацией схемы
- Redis 7 для Temporal
- Temporal Server с PostgreSQL backend
- Temporal Web UI
- Go Worker и API сервисы

#### 7. Retry Policy

- Автоматические повторные попытки для Activities
- Настраиваемые интервалы и максимальное количество попыток
- Исключение невосстанавливаемых ошибок

### 🔄 В процессе реализации

#### 1. Интеграция с PostgreSQL

- Схема базы данных создана
- Миграции подготовлены
- Подключение к БД в коде (частично)

### ❌ Не реализовано

#### 1. Реальные доменные сервисы

- Текущие сервисы используют mock данные
- Нет реальной интеграции с внешними системами

#### 2. Обработка ошибок

- Базовая обработка есть, но можно улучшить
- Нет детального логирования ошибок

#### 3. Тесты

- Отсутствуют unit и integration тесты

#### 4. Мониторинг и метрики

- Нет сбора метрик производительности
- Нет health checks для API

## Как работает система

🔧 Основные компоненты
1. Temporal Worker (cmd/worker/main.go)
Назначение: Запускает воркер, который обрабатывает воркфлоу и активности
Что делает:
Подключается к Temporal серверу
Регистрирует воркфлоу и активности
Ждет задачи для выполнения
Как работает: Запускается как отдельный процесс и работает в фоне
2. API Сервер (cmd/api/main.go)
Назначение: Веб-сервер с REST API и веб-интерфейсом
Что делает:
Принимает HTTP запросы
Запускает воркфлоу через Temporal клиент
Отвечает на запросы о статусе заказов
Отправляет сигналы для отмены заказов
Как работает: Слушает порт 8080, обрабатывает запросы
3. Доменные модели (internal/domain/)
order/order.go:
Определяет структуры заказов (Order, OrderItem, OrderRequest)
Содержит логику изменения статуса заказа
Управляет жизненным циклом заказа
inventory/inventory.go:
Mock-сервис для проверки наличия товаров
Симулирует запросы к складу
Возвращает информацию о доступности
payment/payment.go:
Mock-сервис для обработки платежей
Симулирует различные сценарии оплаты
Возвращает статус транзакции
notification/notification.go:
Mock-сервис для отправки уведомлений
Симулирует email/SMS отправку
Обрабатывает различные типы уведомлений
4. Воркфлоу (internal/application/workflow/)
order_workflow.go:
Основной воркфлоу: OrderWorkflow - последовательно выполняет все шаги
Воркфлоу с отменой: OrderWorkflowWithCancellation - поддерживает отмену через сигналы
Логика: Координирует выполнение активностей, обрабатывает ошибки, применяет retry-политики
activities.go:
CreateOrderActivity: Создает заказ в системе
CheckInventoryActivity: Проверяет наличие товаров
ProcessPaymentActivity: Обрабатывает платеж
SendNotificationActivity: Отправляет уведомление клиенту
CancelOrderActivity: Отменяет заказ
🔄 Как работает система
1. Создание заказа
2. Обработка заказа
3. Обработка ошибок
Каждая активность может завершиться с ошибкой
Retry-политика автоматически повторяет неудачные попытки
После 3 неудачных попыток воркфлоу завершается с ошибкой
4. Отмена заказа
🌐 Веб-интерфейс
templates/index.html:
Форма для создания заказов
Отображение статуса заказов
Кнопки для отмены заказов
JavaScript для взаимодействия с API
⚙️ Конфигурация и запуск
Makefile:
make deps - установка зависимостей
make build - сборка проекта
make run-worker - запуск воркера
make run-api - запуск API сервера
make run - запуск всего вместе
�� Поток данных
Пользователь создает заказ через веб-интерфейс
API сервер получает запрос и запускает воркфлоу
Temporal отправляет задачи воркеру
Воркер выполняет активности по очереди
Результат возвращается через API к пользователю
�� Обработка ошибок
Retry-политика: Автоматические повторные попытки
Graceful degradation: Система продолжает работать даже при сбоях
Логирование: Каждый шаг записывается в лог
Статусы: Пользователь видит текущее состояние заказа
💡 Ключевые особенности
Асинхронность: Воркфлоу выполняется в фоне
Надежность: Temporal гарантирует выполнение или откат
Масштабируемость: Можно запускать несколько воркеров
Мониторинг: Temporal UI показывает все процессы
Отказоустойчивость: Система восстанавливается после сбоев

### 1. Создание заказа

```
1. Пользователь заполняет форму на веб-странице
2. API получает POST запрос с данными заказа
3. Создается Temporal Workflow
4. Workflow выполняет последовательно Activities:
   - CreateOrderActivity
   - CheckInventoryActivity
   - ProcessPaymentActivity
   - SendNotificationActivity
5. Каждый шаг логируется и может быть повторен при ошибке
```

### 2. Обработка ошибок

- При ошибке в Activity срабатывает Retry Policy
- Если ошибка невосстанавливаемая, workflow завершается с ошибкой
- Пользователь получает информацию об ошибке

### 3. Отмена заказа

- Пользователь может отправить сигнал отмены
- Workflow получает сигнал и выполняет CancelOrderActivity
- Заказ помечается как отмененный

## Конфигурация

### Переменные окружения

#### API сервер

- `TEMPORAL_HOST_PORT` - Адрес Temporal сервера
- `POSTGRES_HOST` - Хост PostgreSQL
- `POSTGRES_PORT` - Порт PostgreSQL
- `POSTGRES_USER` - Пользователь PostgreSQL
- `POSTGRES_PASSWORD` - Пароль PostgreSQL
- `POSTGRES_DB` - Имя базы данных
- `API_PORT` - Порт API сервера

#### Worker

- `TEMPORAL_HOST_PORT` - Адрес Temporal сервера
- `POSTGRES_HOST` - Хост PostgreSQL
- `POSTGRES_PORT` - Порт PostgreSQL
- `POSTGRES_USER` - Пользователь PostgreSQL
- `POSTGRES_PASSWORD` - Пароль PostgreSQL
- `POSTGRES_DB` - Имя базы данных

#### Temporal

- `DB` - Тип базы данных (postgresql)
- `DB_PORT` - Порт базы данных
- `POSTGRES_USER` - Пользователь PostgreSQL
- `POSTGRES_PWD` - Пароль PostgreSQL
- `POSTGRES_SEEDS` - Хост PostgreSQL
- `DYNAMIC_CONFIG_FILE_PATH` - Путь к конфигурации

## Команды Makefile

### Основные команды

- `make build` - Сборка приложения
- `make run-api` - Запуск API сервера
- `make run-worker` - Запуск Worker
- `make test` - Запуск тестов
- `make clean` - Очистка артефактов сборки

### Docker команды

- `make docker-build` - Сборка Docker образов
- `make docker-up` - Запуск всех сервисов
- `make docker-down` - Остановка всех сервисов
- `make docker-logs` - Просмотр логов
- `make docker-clean` - Полная очистка Docker

### База данных

- `make db-migrate` - Применение миграций
- `make db-connect` - Подключение к БД
- `make db-reset` - Сброс и пересоздание БД

### Полный стек

- `make start-full-stack` - Запуск всего стека
- `make stop-full-stack` - Остановка всего стека

## Порты сервисов

- **PostgreSQL**: 5432
- **Redis**: 6379
- **Temporal**: 7233 (gRPC), 8233 (HTTP)
- **Temporal Web**: 8088
- **API**: 8080

## Схема базы данных

### Таблицы

1. **orders** - Основная информация о заказах
2. **order_items** - Позиции заказа
3. **products** - Каталог товаров
4. **payments** - Информация о платежах
5. **notifications** - История уведомлений

### Индексы

- Созданы индексы для оптимизации запросов
- Автоматическое обновление `updated_at` через триггеры

## Текущие проблемы и ограничения

### 1. Mock данные

- Сервисы используют заглушки вместо реальных данных
- Нет реальной интеграции с внешними системами

### 2. Обработка ошибок

- Базовая обработка ошибок реализована
- Можно улучшить детализацию и логирование

### 3. Безопасность

- Нет аутентификации и авторизации
- Пароли в открытом виде в docker-compose

### 4. Масштабируемость

- Нет горизонтального масштабирования
- Нет балансировки нагрузки

## Планы развития

### Краткосрочные (1-2 недели)

1. ✅ Интегрировать PostgreSQL в код приложения
2. ✅ Заменить mock сервисы на реальные
3. ✅ Добавить детальное логирование
4. ✅ Улучшить обработку ошибок

### Среднесрочные (1-2 месяца)

1. Добавить аутентификацию и авторизацию
2. Реализовать unit и integration тесты
3. Добавить метрики и мониторинг
4. Улучшить веб-интерфейс

### Долгосрочные (3-6 месяцев)

1. Добавить горизонтальное масштабирование
2. Реализовать CI/CD pipeline
3. Добавить поддержку микросервисов
4. Интеграция с внешними системами (платежи, логистика)

## Примеры использования

### Создание заказа через API

```bash
curl -X POST http://localhost:8080/api/orders \
  -H "Content-Type: application/json" \
  -d '{
    "customerID": "CUST-001",
    "totalAmount": 1299.99,
    "items": [
      {
        "productID": "PROD-001",
        "quantity": 1,
        "unitPrice": 1299.99
      }
    ]
  }'
```

### Проверка статуса заказа

```bash
curl http://localhost:8080/api/orders/WORKFLOW_ID
```

### Отмена заказа

```bash
curl -X POST http://localhost:8080/api/orders/WORKFLOW_ID/cancel
```

## Логирование

Система использует структурированное логирование через Zap Logger:

- **API**: Логирует HTTP запросы и ответы
- **Worker**: Логирует выполнение Activities
- **Workflow**: Логирует состояние workflow
- **Activities**: Логируют детали выполнения

## Мониторинг

### Temporal Web UI

- Доступен по адресу http://localhost:8088
- Показывает все workflows и их статус
- Позволяет отслеживать выполнение в реальном времени

### Логи контейнеров

```bash
# Все сервисы
docker compose logs -f

# Конкретный сервис
docker compose logs -f api
docker compose logs -f worker
docker compose logs -f temporal
```

## Troubleshooting

### Частые проблемы

#### 1. Temporal не запускается

- Проверить логи: `docker compose logs temporal`
- Убедиться, что PostgreSQL доступен
- Проверить конфигурацию в `temporal-config/`

#### 2. API не может подключиться к Temporal

- Проверить переменные окружения
- Убедиться, что Temporal запущен и доступен

#### 3. Проблемы с базой данных

- Проверить подключение: `make db-connect`
- Применить миграции: `make db-migrate`
- Сбросить БД при необходимости: `make db-reset`

#### 4. Docker build ошибки

- Очистить кэш: `make docker-clean`
- Пересобрать образы: `make docker-build`

## Заключение

OrderFlow представляет собой полнофункциональную систему обработки заказов, построенную на современных технологиях. Система демонстрирует возможности Temporal.io для оркестрации сложных бизнес-процессов и готова для дальнейшего развития и интеграции с реальными системами.

Основные преимущества:

- Надежная оркестрация процессов через Temporal
- Модульная архитектура с четким разделением ответственности
- Готовность к production развертыванию через Docker
- Простота расширения и добавления новых функций
